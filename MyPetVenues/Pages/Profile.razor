@page "/profile"
@using MyPetVenues.Models
@using MyPetVenues.Services
@using MyPetVenues.Components
@inject IUserService UserService
@inject IVenueService VenueService
@inject IBookingService BookingService
@inject NavigationManager Navigation

<PageTitle>My Profile - MyPetVenues üêæ</PageTitle>

<div class="profile-page">
    @if (_isLoading)
    {
        <div class="loading-state">
            <span class="loading-emoji">üêæ</span>
            <p>Loading your profile...</p>
        </div>
    }
    else if (_user is null)
    {
        <div class="not-found-state">
            <span class="not-found-emoji">üë§</span>
            <h2>Profile Not Found</h2>
            <p>Please sign in to view your profile.</p>
        </div>
    }
    else
    {
        <!-- Profile Header -->
        <section class="profile-header">
            <div class="profile-avatar">
                <img src="@_user.Avatar" alt="@_user.Name" />
                <button class="edit-avatar-btn" title="Change photo">üì∑</button>
            </div>
            <div class="profile-info">
                <h1>@_user.Name</h1>
                <p class="profile-location">üìç @_user.Location</p>
                <p class="profile-bio">@_user.Bio</p>
                <div class="profile-stats">
                    <div class="stat">
                        <span class="stat-value">@_user.Pets.Count</span>
                        <span class="stat-label">Pets</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">@_favoriteVenues?.Count</span>
                        <span class="stat-label">Favorites</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">@_bookings?.Count</span>
                        <span class="stat-label">Bookings</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">@GetMemberDuration()</span>
                        <span class="stat-label">Member</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-outline edit-profile-btn" @onclick="OpenEditProfile">
                ‚úèÔ∏è Edit Profile
            </button>
        </section>

        <!-- Tab Navigation -->
        <nav class="profile-tabs">
            <button class="tab-btn @(_activeTab == "pets" ? "active" : "")" @onclick="SetTabPets">
                üêæ My Pets
            </button>
            <button class="tab-btn @(_activeTab == "favorites" ? "active" : "")" @onclick="SetTabFavorites">
                ‚ù§Ô∏è Favorites
            </button>
            <button class="tab-btn @(_activeTab == "bookings" ? "active" : "")" @onclick="SetTabBookings">
                üìÖ Bookings
            </button>
            <button class="tab-btn @(_activeTab == "settings" ? "active" : "")" @onclick="SetTabSettings">
                ‚öôÔ∏è Settings
            </button>
        </nav>

        <!-- Tab Content -->
        <div class="tab-content">
            @switch (_activeTab)
            {
                case "pets":
                    <section class="pets-section">
                        <div class="section-header-row">
                            <h2>My Furry Family üêæ</h2>
                            <button class="btn btn-primary" @onclick="OpenAddPet">‚ûï Add Pet</button>
                        </div>
                        <div class="pets-grid">
                            @foreach (var pet in _user.Pets)
                            {
                                <div class="pet-card">
                                    <div class="pet-image">
                                        <img src="@pet.ImageUrl" alt="@pet.Name" />
                                    </div>
                                    <div class="pet-info">
                                        <h3>@pet.Name @GetPetEmoji(pet.Type)</h3>
                                        <p class="pet-breed">@pet.Breed</p>
                                        <p class="pet-age">@pet.Age years old</p>
                                        <PetBadge Type="@pet.Type" />
                                    </div>
                                    <div class="pet-actions">
                                        <button class="action-btn" title="Edit" @onclick="() => OpenEditPet(pet)" @onclick:stopPropagation>‚úèÔ∏è</button>
                                        <button class="action-btn" title="Delete" @onclick="() => DeletePet(pet)" @onclick:stopPropagation>üóëÔ∏è</button>
                                    </div>
                                </div>
                            }
                        </div>
                    </section>
                    break;

                case "favorites":
                    <section class="favorites-section">
                        <h2>My Favorite Venues ‚ù§Ô∏è</h2>
                        @if (_favoriteVenues is null || !_favoriteVenues.Any())
                        {
                            <div class="empty-section">
                                <span class="empty-icon">‚ù§Ô∏è</span>
                                <h3>No favorites yet</h3>
                                <p>Start exploring and save your favorite pet-friendly venues!</p>
                                <button class="btn btn-primary" @onclick="NavigateToVenues">
                                    Explore Venues
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="favorites-grid">
                                @foreach (var venue in _favoriteVenues)
                                {
                                    <VenueCard Venue="@venue" OnClick="() => NavigateToVenueDetail(venue.Id)" />
                                }
                            </div>
                        }
                    </section>
                    break;

                case "bookings":
                    <section class="bookings-section">
                        <h2>My Bookings üìÖ</h2>
                        @if (_bookings is null || !_bookings.Any())
                        {
                            <div class="empty-section">
                                <span class="empty-icon">üìÖ</span>
                                <h3>No bookings yet</h3>
                                <p>Book your first pet-friendly experience!</p>
                                <button class="btn btn-primary" @onclick="NavigateToBooking">
                                    Make a Booking
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="bookings-list">
                                @foreach (var booking in _bookings)
                                {
                                    <div class="booking-card @booking.Status.ToString().ToLower()">
                                        <div class="booking-image">
                                            <img src="@booking.VenueImage" alt="@booking.VenueName" />
                                        </div>
                                        <div class="booking-details">
                                            <h3>@booking.VenueName</h3>
                                            <div class="booking-info-row">
                                                <span>üìÖ @booking.BookingDate.ToString("MMM d, yyyy")</span>
                                                <span>‚è∞ @booking.StartTime.ToString(@"hh\:mm") - @booking.EndTime.ToString(@"hh\:mm")</span>
                                            </div>
                                            <div class="booking-pets">
                                                üêæ @string.Join(", ", booking.PetNames)
                                            </div>
                                        </div>
                                        <div class="booking-status-col">
                                            <span class="booking-status @booking.Status.ToString().ToLower()">
                                                @GetStatusEmoji(booking.Status) @booking.Status
                                            </span>
                                            <span class="booking-price">$@booking.TotalPrice</span>
                                        </div>
                                        <div class="booking-actions">
                                            @if (booking.Status == BookingStatus.Confirmed)
                                            {
                                                <button class="btn btn-outline btn-sm">View Details</button>
                                                <button class="btn btn-secondary btn-sm" @onclick="() => CancelBooking(booking.Id)">Cancel</button>
                                            }
                                            else if (booking.Status == BookingStatus.Completed)
                                            {
                                                <button class="btn btn-primary btn-sm">Leave Review</button>
                                                <button class="btn btn-outline btn-sm">Book Again</button>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </section>
                    break;

                case "settings":
                    <section class="settings-section">
                        <h2>Account Settings ‚öôÔ∏è</h2>
                        
                        <div class="settings-card">
                            <h3>üìß Email Preferences</h3>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <span class="setting-label">Email Notifications</span>
                                    <span class="setting-desc">Receive updates about bookings and new venues</span>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" @bind="_user.Preferences.EmailNotifications" />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <span class="setting-label">Push Notifications</span>
                                    <span class="setting-desc">Get instant alerts for booking confirmations</span>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" @bind="_user.Preferences.PushNotifications" />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3>üîç Search Preferences</h3>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <span class="setting-label">Search Radius</span>
                                    <span class="setting-desc">Default distance for venue search</span>
                                </div>
                                <select @bind="_user.Preferences.SearchRadius">
                                    <option value="10">10 miles</option>
                                    <option value="25">25 miles</option>
                                    <option value="50">50 miles</option>
                                    <option value="100">100 miles</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-card danger">
                            <h3>‚ö†Ô∏è Danger Zone</h3>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <span class="setting-label">Delete Account</span>
                                    <span class="setting-desc">Permanently delete your account and all data</span>
                                </div>
                                <button class="btn btn-danger">Delete Account</button>
                            </div>
                        </div>
                    </section>
                    break;
            }
        </div>
        
        @* Edit Profile Modal *@
        @if (_isEditing)
        {
            <div class="modal-overlay" @onclick="CloseEditProfile">
                <div class="modal-content" @onclick:stopPropagation>
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Edit Profile</h2>
                        <button class="modal-close" @onclick="CloseEditProfile">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" @bind="_editName" placeholder="Your name" />
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" @bind="_editLocation" placeholder="City, State" />
                        </div>
                        <div class="form-group">
                            <label>Bio</label>
                            <textarea @bind="_editBio" rows="3" placeholder="Tell us about yourself..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseEditProfile">Cancel</button>
                        <button class="btn btn-primary" @onclick="SaveProfile">üíæ Save Changes</button>
                    </div>
                </div>
            </div>
        }
        
        @* Add/Edit Pet Modal *@
        @if (_isAddingPet)
        {
            <div class="modal-overlay" @onclick="CloseAddPet">
                <div class="modal-content" @onclick:stopPropagation>
                    <div class="modal-header">
                        <h2>@(_isEditingPet ? "‚úèÔ∏è Edit Pet" : "‚ûï Add New Pet")</h2>
                        <button class="modal-close" @onclick="CloseAddPet">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="pet-preview">
                            <img src="@_editingPet.ImageUrl" alt="Pet preview" />
                        </div>
                        <div class="form-group">
                            <label>Pet Name</label>
                            <input type="text" @bind="_editingPet.Name" placeholder="e.g., Buddy" />
                        </div>
                        <div class="form-group">
                            <label>Pet Type</label>
                            <select value="@_editingPet.Type" @onchange="OnPetTypeChanged">
                                <option value="@PetType.Dog">üêï Dog</option>
                                <option value="@PetType.Cat">üê± Cat</option>
                                <option value="@PetType.Bird">üê¶ Bird</option>
                                <option value="@PetType.Rabbit">üê∞ Rabbit</option>
                                <option value="@PetType.SmallPet">üêπ Small Pet</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Breed</label>
                            <input type="text" @bind="_editingPet.Breed" placeholder="e.g., Golden Retriever" />
                        </div>
                        <div class="form-group">
                            <label>Age (years)</label>
                            <input type="number" @bind="_editingPet.Age" min="0" max="30" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseAddPet">Cancel</button>
                        <button class="btn btn-primary" @onclick="SavePet">@(_isEditingPet ? "üíæ Save Changes" : "‚ûï Add Pet")</button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private User? _user;
    private List<Venue>? _favoriteVenues;
    private List<Models.Booking>? _bookings;
    private bool _isLoading = true;
    private bool _isEditing = false;
    private bool _isAddingPet = false;
    private bool _isEditingPet = false;
    private string _activeTab = "pets";
    
    // Edit profile form fields
    private string _editName = "";
    private string _editLocation = "";
    private string _editBio = "";
    
    // Add/Edit pet form fields
    private Pet _editingPet = new();
    private int _nextPetId = 100;

    private void SetTabPets() => _activeTab = "pets";
    private void SetTabFavorites() => _activeTab = "favorites";
    private void SetTabBookings() => _activeTab = "bookings";
    private void SetTabSettings() => _activeTab = "settings";
    
    private void NavigateToVenues() => Navigation.NavigateTo("/venues");
    private void NavigateToBooking() => Navigation.NavigateTo("/booking");
    private void NavigateToVenueDetail(int id) => Navigation.NavigateTo($"/venues/{id}");

    protected override async Task OnInitializedAsync()
    {
        _user = await UserService.GetCurrentUserAsync();
        
        if (_user is not null)
        {
            _favoriteVenues = await UserService.GetFavoriteVenuesAsync();
            _bookings = await BookingService.GetUserBookingsAsync(_user.Id);
        }
        
        _isLoading = false;
    }

    private string GetMemberDuration()
    {
        if (_user is null) return "";
        var duration = DateTime.Now - _user.JoinedDate;
        if (duration.TotalDays < 30) return $"{(int)duration.TotalDays}d";
        if (duration.TotalDays < 365) return $"{(int)(duration.TotalDays / 30)}mo";
        return $"{(int)(duration.TotalDays / 365)}y";
    }

    private string GetPetEmoji(PetType type) => type switch
    {
        PetType.Dog => "üêï",
        PetType.Cat => "üê±",
        PetType.Bird => "üê¶",
        PetType.Rabbit => "üê∞",
        PetType.SmallPet => "üêπ",
        _ => "üêæ"
    };

    private string GetStatusEmoji(BookingStatus status) => status switch
    {
        BookingStatus.Pending => "‚è≥",
        BookingStatus.Confirmed => "‚úÖ",
        BookingStatus.Cancelled => "‚ùå",
        BookingStatus.Completed => "üéâ",
        _ => "üìã"
    };

    private async Task CancelBooking(int bookingId)
    {
        await BookingService.CancelBookingAsync(bookingId);
        if (_user is not null)
        {
            _bookings = await BookingService.GetUserBookingsAsync(_user.Id);
        }
    }
    
    // Edit Profile Methods
    private void OpenEditProfile()
    {
        if (_user is null) return;
        _editName = _user.Name;
        _editLocation = _user.Location;
        _editBio = _user.Bio;
        _isEditing = true;
    }
    
    private void CloseEditProfile()
    {
        _isEditing = false;
    }
    
    private async Task SaveProfile()
    {
        if (_user is null) return;
        _user.Name = _editName;
        _user.Location = _editLocation;
        _user.Bio = _editBio;
        await UserService.UpdateUserAsync(_user);
        _isEditing = false;
    }
    
    // Add/Edit Pet Methods
    private void OpenAddPet()
    {
        _editingPet = new Pet
        {
            Id = _nextPetId++,
            Type = PetType.Dog,
            ImageUrl = "images/pets/dog1.png"
        };
        _isEditingPet = false;
        _isAddingPet = true;
    }
    
    private void OpenEditPet(Pet pet)
    {
        _editingPet = new Pet
        {
            Id = pet.Id,
            Name = pet.Name,
            Type = pet.Type,
            Breed = pet.Breed,
            Age = pet.Age,
            ImageUrl = pet.ImageUrl
        };
        _isEditingPet = true;
        _isAddingPet = true;
    }
    
    private void CloseAddPet()
    {
        _isAddingPet = false;
        _isEditingPet = false;
    }
    
    private async Task SavePet()
    {
        if (_user is null) return;
        
        if (_isEditingPet)
        {
            var existingPet = _user.Pets.FirstOrDefault(p => p.Id == _editingPet.Id);
            if (existingPet is not null)
            {
                existingPet.Name = _editingPet.Name;
                existingPet.Type = _editingPet.Type;
                existingPet.Breed = _editingPet.Breed;
                existingPet.Age = _editingPet.Age;
                existingPet.ImageUrl = _editingPet.ImageUrl;
            }
        }
        else
        {
            _user.Pets.Add(_editingPet);
        }
        
        await UserService.UpdateUserAsync(_user);
        _isAddingPet = false;
        _isEditingPet = false;
    }
    
    private async Task DeletePet(Pet pet)
    {
        if (_user is null) return;
        _user.Pets.Remove(pet);
        await UserService.UpdateUserAsync(_user);
    }
    
    private string GetPetImageForType(PetType type) => type switch
    {
        PetType.Dog => "images/pets/dog1.png",
        PetType.Cat => "images/pets/cat1.jpg",
        PetType.Bird => "images/pets/bird.jpg",
        PetType.Rabbit => "images/pets/bunny.jpg",
        PetType.SmallPet => "images/pets/hedgehog.jpg",
        _ => "images/pets/dog1.png"
    };
    
    private void OnPetTypeChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<PetType>(e.Value?.ToString(), out var petType))
        {
            _editingPet.Type = petType;
            _editingPet.ImageUrl = GetPetImageForType(petType);
        }
    }
}
